<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cjc.seektam.mapper.GroupDAO">
	<select id="findMyGr" resultType="string">
		select gr_name from group_member where mem_id=#{userId} and relation=1
	</select>
	<select id="findGrMember" resultType="string">
		select mem_id from group_member where gr_name in
		<foreach collection="myGrList" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</select>
	<!-- 내가 생성한 그룹 -->
	<select id="selectMyGroup" resultType="groupsDTO">
		select * from groups where group_leader=#{memId}
	</select>
	<!-- 내가 가입한 그룹의 정보와 그룹 가입일 join으로 가져오기 -->
	<select id="selectJoinedGr" resultType="groupsDTO">
		SELECT 
			g.num, g.name, g.area, g.GROUP_LEADER, g.NUM_OF_MEM, g.activity_score, g.open, m.REG 
		FROM 
			(SELECT * FROM group_member WHERE mem_id=#{memId}) m, groups g 
		WHERE 
			g.name = m.gr_name
	</select>
	<!-- 그룹명과 활동지역으로 그룹 검색 -->
	<select id="selectSearchGr" parameterType="hashmap" resultType="groupsDTO">
		SELECT * 
		FROM (SELECT * FROM groups WHERE ${search} LIKE ('%${keyword}%') )
		<if test="!joinedGr.isEmpty">
			WHERE name 
			NOT IN 
			<foreach collection="joinedGr" item="item" open="(" close=")" separator=",">
				#{item.name}
			</foreach>
		</if>
	</select>
	<!-- 그룹생성함과 동시에 -->
	<update id="insertMyGr" parameterType="groupsDTO">
		{call
			declare
			begin
				insert into groups values(groups_seq.nextval, #{name},#{area},#{group_leader},1,0, #{open}, sysdate);
				insert into group_member values(group_member_seq.nextval, #{name}, #{group_leader},1,sysdate);
			end
		}
	</update>
	<!-- //////////////////////////////////////////////////////////////// -->
</mapper>